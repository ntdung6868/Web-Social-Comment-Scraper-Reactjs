// web-scraper/backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // <--- ĐÃ SỬA THÀNH SQLITE
  url      = env("DATABASE_URL")
}

// ===========================================
// User Model
// ===========================================
model User {
  id             Int      @id @default(autoincrement())
  username       String   @unique
  email          String   @unique
  passwordHash   String   @map("password_hash")
  createdAt      DateTime @default(now()) @map("created_at")
  isActive       Boolean  @default(true) @map("is_active")

  // Plan & Subscription
  isAdmin           Boolean    @default(false) @map("is_admin")
  planType          String     @default("FREE") @map("plan_type") // SQLite không hỗ trợ Enum native tốt, dùng String
  planStatus        String     @default("ACTIVE") @map("plan_status")
  trialUses         Int        @default(3) @map("trial_uses")
  maxTrialUses      Int        @default(3) @map("max_trial_uses")
  subscriptionStart DateTime?  @map("subscription_start")
  subscriptionEnd   DateTime?  @map("subscription_end")

  // Ban status
  isBanned  Boolean   @default(false) @map("is_banned")
  banReason String?   @map("ban_reason")
  bannedAt  DateTime? @map("banned_at")

  // Password reset
  resetToken       String?   @unique @map("reset_token")
  resetTokenExpiry DateTime? @map("reset_token_expiry")

  // Rate limiting
  lastPasswordChange       DateTime? @map("last_password_change")
  lastEmailChange          DateTime? @map("last_email_change")
  lastPasswordResetRequest DateTime? @map("last_password_reset_request")

  // TikTok Cookie
  tiktokCookieFile      String?   @map("tiktok_cookie_file")
  tiktokCookieData      String?   @map("tiktok_cookie_data")
  tiktokCookieUserAgent String?   @map("tiktok_cookie_user_agent")
  tiktokCookieValidAt   DateTime? @map("tiktok_cookie_valid_at")
  tiktokCookieStatus    String    @default("UNKNOWN") @map("tiktok_cookie_status")
  useTiktokCookie       Boolean   @default(false) @map("use_tiktok_cookie")

  // Facebook Cookie
  facebookCookieFile      String?   @map("facebook_cookie_file")
  facebookCookieData      String?   @map("facebook_cookie_data")
  facebookCookieUserAgent String?   @map("facebook_cookie_user_agent")
  facebookCookieValidAt   DateTime? @map("facebook_cookie_valid_at")
  facebookCookieStatus    String    @default("UNKNOWN") @map("facebook_cookie_status")
  useFacebookCookie       Boolean   @default(false) @map("use_facebook_cookie")

  // Proxy settings
  proxyEnabled      Boolean @default(false) @map("proxy_enabled")
  proxyList         String? @map("proxy_list")
  proxyRotation     String  @default("RANDOM") @map("proxy_rotation")
  currentProxyIndex Int     @default(0) @map("current_proxy_index")

  // Scraper settings
  headlessMode Boolean @default(true) @map("headless_mode")

  // Relations
  scrapeHistories ScrapeHistory[]
  refreshTokens   RefreshToken[]

  @@map("users")
}

// ===========================================
// Refresh Token Model
// ===========================================
model RefreshToken {
  id         Int       @id @default(autoincrement())
  tokenHash  String    @unique @map("token_hash")
  userId     Int       @map("user_id")
  expiresAt  DateTime  @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  isRevoked  Boolean   @default(false) @map("is_revoked")
  revokedAt  DateTime? @map("revoked_at")
  userAgent  String?   @map("user_agent")
  ipAddress  String?   @map("ip_address")
  deviceInfo String?   @map("device_info")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ===========================================
// Scrape History Model
// ===========================================
model ScrapeHistory {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  platform      String // Enum -> String
  url           String
  totalComments Int      @default(0) @map("total_comments")
  status        String   @default("PENDING") // Enum -> String
  errorMessage  String?  @map("error_message")
  createdAt     DateTime @default(now()) @map("created_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments Comment[]

  @@index([userId])
  @@index([createdAt])
  @@map("scrape_histories")
}

// ===========================================
// Comment Model
// ===========================================
model Comment {
  id              Int      @id @default(autoincrement())
  scrapeHistoryId Int      @map("scrape_history_id")
  username        String
  content         String
  timestamp       String?
  likes           Int      @default(0)
  scrapedAt       DateTime @default(now()) @map("scraped_at")

  scrapeHistory ScrapeHistory @relation(fields: [scrapeHistoryId], references: [id], onDelete: Cascade)

  @@index([scrapeHistoryId])
  @@map("comments")
}

// ===========================================
// Global Settings Model
// ===========================================
model GlobalSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String?
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy Int?     @map("updated_by")

  @@index([key])
  @@map("global_settings")
}