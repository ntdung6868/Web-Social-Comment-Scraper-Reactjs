// ===========================================
// Prisma Schema - Database Models
// ===========================================
// Migrated from Python/SQLAlchemy models
// PostgreSQL database with strict typing

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// User Model
// ===========================================
model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique @db.VarChar(80)
  email        String   @unique @db.VarChar(120)
  passwordHash String   @map("password_hash") @db.VarChar(256)
  createdAt    DateTime @default(now()) @map("created_at")
  isActive     Boolean  @default(true) @map("is_active")

  // Plan & Subscription
  isAdmin           Boolean   @default(false) @map("is_admin")
  planType          PlanType  @default(FREE) @map("plan_type")
  planStatus        PlanStatus @default(ACTIVE) @map("plan_status")
  trialUses         Int       @default(3) @map("trial_uses")
  maxTrialUses      Int       @default(3) @map("max_trial_uses")
  subscriptionStart DateTime? @map("subscription_start")
  subscriptionEnd   DateTime? @map("subscription_end")

  // Ban status
  isBanned  Boolean   @default(false) @map("is_banned")
  banReason String?   @map("ban_reason") @db.VarChar(500)
  bannedAt  DateTime? @map("banned_at")

  // Password reset
  resetToken       String?   @unique @map("reset_token") @db.VarChar(100)
  resetTokenExpiry DateTime? @map("reset_token_expiry")

  // Rate limiting for sensitive actions (7 days cooldown)
  lastPasswordChange       DateTime? @map("last_password_change")
  lastEmailChange          DateTime? @map("last_email_change")
  lastPasswordResetRequest DateTime? @map("last_password_reset_request")

  // TikTok Cookie settings (enhanced for session management)
  tiktokCookieFile      String?   @map("tiktok_cookie_file") @db.VarChar(255)
  tiktokCookieData      String?   @map("tiktok_cookie_data") @db.Text
  tiktokCookieUserAgent String?   @map("tiktok_cookie_user_agent") @db.VarChar(500)
  tiktokCookieValidAt   DateTime? @map("tiktok_cookie_valid_at")
  tiktokCookieStatus    CookieStatus @default(UNKNOWN) @map("tiktok_cookie_status")
  useTiktokCookie       Boolean   @default(false) @map("use_tiktok_cookie")

  // Facebook Cookie settings (enhanced for session management)
  facebookCookieFile      String?   @map("facebook_cookie_file") @db.VarChar(255)
  facebookCookieData      String?   @map("facebook_cookie_data") @db.Text
  facebookCookieUserAgent String?   @map("facebook_cookie_user_agent") @db.VarChar(500)
  facebookCookieValidAt   DateTime? @map("facebook_cookie_valid_at")
  facebookCookieStatus    CookieStatus @default(UNKNOWN) @map("facebook_cookie_status")
  useFacebookCookie       Boolean   @default(false) @map("use_facebook_cookie")

  // Proxy settings
  proxyEnabled      Boolean  @default(false) @map("proxy_enabled")
  proxyList         String?  @map("proxy_list") @db.Text
  proxyRotation     ProxyRotation @default(RANDOM) @map("proxy_rotation")
  currentProxyIndex Int      @default(0) @map("current_proxy_index")

  // Scraper settings
  headlessMode Boolean @default(true) @map("headless_mode")

  // Relations
  scrapeHistories ScrapeHistory[]
  refreshTokens   RefreshToken[]

  @@map("users")
}

// ===========================================
// Refresh Token Model (for JWT)
// ===========================================
// Stores HASHED refresh tokens for security
model RefreshToken {
  id          Int      @id @default(autoincrement())
  tokenHash   String   @unique @map("token_hash") @db.VarChar(64) // SHA-256 hash
  userId      Int      @map("user_id")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  isRevoked   Boolean  @default(false) @map("is_revoked")
  revokedAt   DateTime? @map("revoked_at")
  userAgent   String?  @map("user_agent") @db.VarChar(500)
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  deviceInfo  String?  @map("device_info") @db.VarChar(255) // e.g., "Chrome on Windows"

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ===========================================
// Scrape History Model
// ===========================================
model ScrapeHistory {
  id            Int           @id @default(autoincrement())
  userId        Int           @map("user_id")
  platform      Platform
  url           String        @db.VarChar(500)
  totalComments Int           @default(0) @map("total_comments")
  status        ScrapeStatus  @default(PENDING)
  errorMessage  String?       @map("error_message") @db.Text
  createdAt     DateTime      @default(now()) @map("created_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments Comment[]

  @@index([userId])
  @@index([createdAt])
  @@map("scrape_histories")
}

// ===========================================
// Comment Model
// ===========================================
model Comment {
  id              Int      @id @default(autoincrement())
  scrapeHistoryId Int      @map("scrape_history_id")
  username        String   @db.VarChar(100)
  content         String   @db.Text
  timestamp       String?  @db.VarChar(100) // Original timestamp from source
  likes           Int      @default(0)
  scrapedAt       DateTime @default(now()) @map("scraped_at")

  // Relations
  scrapeHistory ScrapeHistory @relation(fields: [scrapeHistoryId], references: [id], onDelete: Cascade)

  @@index([scrapeHistoryId])
  @@map("comments")
}

// ===========================================
// Global Settings Model
// ===========================================
model GlobalSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100)
  value     String?  @db.Text
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy Int?     @map("updated_by")

  @@index([key])
  @@map("global_settings")
}

// ===========================================
// Enums
// ===========================================
enum PlanType {
  FREE
  PRO

  @@map("plan_type")
}

enum PlanStatus {
  ACTIVE
  EXPIRED

  @@map("plan_status")
}

enum Platform {
  TIKTOK
  FACEBOOK

  @@map("platform")
}

enum ScrapeStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED

  @@map("scrape_status")
}

enum ProxyRotation {
  RANDOM
  SEQUENTIAL

  @@map("proxy_rotation")
}

enum CookieStatus {
  UNKNOWN
  VALID
  INVALID
  EXPIRED

  @@map("cookie_status")
}
