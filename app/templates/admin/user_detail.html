{% extends "base_dashboard.html" %}
{% block title %}User: {{ user.username }} - Admin{% endblock %}

{% block content %}
<div class="p-8">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <a href="{{ url_for('admin.dashboard') }}" class="mr-4 p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
          <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
        </a>
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
            <span class="text-2xl mr-2">üë§</span> Chi ti·∫øt User
          </h1>
          <p class="text-gray-500 dark:text-gray-400 mt-1">Xem v√† ch·ªânh s·ª≠a th√¥ng tin ng∆∞·ªùi d√πng</p>
        </div>
      </div>
      
      <!-- Delete Button -->
      {% if not user.is_admin %}
      <button onclick="openDeleteModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
        X√≥a User
      </button>
      {% endif %}
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- User Info Card -->
    <div class="lg:col-span-1">
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
        <div class="text-center">
          <div class="w-24 h-24 mx-auto rounded-full bg-primary-100 dark:bg-primary-900/50 flex items-center justify-center mb-4">
            <span class="text-4xl font-bold text-primary-600 dark:text-primary-400">
              {{ user.username[0].upper() }}
            </span>
          </div>
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">{{ user.username }}</h2>
          <p class="text-gray-500 dark:text-gray-400">{{ user.email }}</p>
          
          <!-- Status Badges -->
          <div class="mt-4 flex flex-wrap justify-center gap-2">
            {% if user.is_admin %}
            <span class="px-3 py-1 text-sm bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 rounded-full">
              üëë Admin
            </span>
            {% endif %}
            
            {% if user.plan_type == 'pro' %}
            <span class="px-3 py-1 text-sm bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 rounded-full">
              ‚≠ê PRO
            </span>
            {% else %}
            <span class="px-3 py-1 text-sm bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300 rounded-full">
              FREE
            </span>
            {% endif %}
            
            {% if user.is_banned %}
            <span class="px-3 py-1 text-sm bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 rounded-full">
              üö´ Banned
            </span>
            {% endif %}
          </div>
        </div>
        
        <!-- Quick Info -->
        <div class="mt-6 space-y-3 border-t border-gray-200 dark:border-slate-700 pt-6">
          <div class="flex justify-between">
            <span class="text-sm text-gray-500 dark:text-gray-400">User ID</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ user.id }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-sm text-gray-500 dark:text-gray-400">Ng√†y ƒëƒÉng k√Ω</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ user.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-sm text-gray-500 dark:text-gray-400">Trial c√≤n l·∫°i</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ user.trial_uses }}/{{ user.max_trial_uses }}</span>
          </div>
          {% if user.plan_type == 'pro' and user.subscription_end %}
          <div class="flex justify-between">
            <span class="text-sm text-gray-500 dark:text-gray-400">H·∫øt h·∫°n Pro</span>
            <span class="text-sm font-medium {% if user.subscription_end < now %}text-red-600 dark:text-red-400{% else %}text-green-600 dark:text-green-400{% endif %}">
              {{ user.subscription_end.strftime('%d/%m/%Y') }}
            </span>
          </div>
          {% endif %}
          {% if user.is_banned %}
          <div class="flex justify-between">
            <span class="text-sm text-gray-500 dark:text-gray-400">L√Ω do ban</span>
            <span class="text-sm font-medium text-red-600 dark:text-red-400">{{ user.ban_reason or 'Kh√¥ng r√µ' }}</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Edit Form -->
    <div class="lg:col-span-2">
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
          Ch·ªânh s·ª≠a th√¥ng tin
        </h3>
        
        <form action="{{ url_for('admin.edit_user', user_id=user.id) }}" method="POST" class="space-y-6">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Username -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Username
              </label>
              <input type="text" name="username" value="{{ user.username }}" 
                     class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                     {% if user.is_admin and user.id != current_user.id %}disabled{% endif %}>
            </div>
            
            <!-- Email -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Email
              </label>
              <input type="email" name="email" value="{{ user.email }}"
                     class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                     {% if user.is_admin and user.id != current_user.id %}disabled{% endif %}>
            </div>
            
            <!-- Password -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                M·∫≠t kh·∫©u m·ªõi <span class="text-gray-400">(ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</span>
              </label>
              <div class="relative">
                <input type="password" id="admin_password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                       class="w-full px-4 py-2 pr-10 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                       {% if user.is_admin and user.id != current_user.id %}disabled{% endif %}>
                <button type="button" onclick="togglePassword('admin_password', this)" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                  <svg class="eye-open h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                  <svg class="eye-closed h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- Trial Uses -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                S·ªë l∆∞·ª£t Trial
              </label>
              <input type="number" name="trial_uses" value="{{ user.trial_uses }}" min="0" max="100"
                     class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                     {% if user.is_admin and user.id != current_user.id %}disabled{% endif %}>
            </div>
            
            <!-- Plan Type -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                G√≥i d·ªãch v·ª•
              </label>
              <select name="plan_type" id="plan_type" onchange="toggleProFields()"
                      class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                      {% if user.is_admin and user.id != current_user.id %}disabled{% endif %}>
                <option value="free" {% if user.plan_type == 'free' %}selected{% endif %}>FREE</option>
                <option value="pro" {% if user.plan_type == 'pro' %}selected{% endif %}>PRO</option>
              </select>
            </div>
            
            <!-- Subscription End -->
            <div id="proFields" class="{% if user.plan_type != 'pro' %}hidden{% endif %}">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Ng√†y h·∫øt h·∫°n Pro
              </label>
              <input type="date" name="subscription_end" 
                     value="{{ user.subscription_end.strftime('%Y-%m-%d') if user.subscription_end else '' }}"
                     class="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                     {% if user.is_admin and user.id != current_user.id %}disabled{% endif %}>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="border-t border-gray-200 dark:border-slate-700 pt-6">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Thao t√°c nhanh</h4>
            <div class="flex flex-wrap gap-3">
              {% if not user.is_admin %}
                {% if user.is_banned %}
                <a href="#" onclick="submitQuickAction('unban')" 
                   class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors">
                  ‚úì Unban User
                </a>
                {% else %}
                <a href="#" onclick="openBanModal()" 
                   class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors">
                  üö´ Ban User
                </a>
                {% endif %}
                
                <a href="#" onclick="submitQuickAction('reset_trial')" 
                   class="px-4 py-2 bg-yellow-600 text-white text-sm rounded-lg hover:bg-yellow-700 transition-colors">
                  üîÑ Reset Trial
                </a>
                
                {% if user.plan_type == 'free' %}
                <a href="#" onclick="submitQuickAction('upgrade')" 
                   class="px-4 py-2 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700 transition-colors">
                  ‚≠ê Upgrade Pro (30 ng√†y)
                </a>
                {% else %}
                <a href="#" onclick="submitQuickAction('downgrade')" 
                   class="px-4 py-2 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700 transition-colors">
                  ‚Üì Downgrade Free
                </a>
                {% endif %}
              {% endif %}
            </div>
          </div>
          
          <!-- Submit Button -->
          <div class="flex justify-end pt-4 border-t border-gray-200 dark:border-slate-700">
            <button type="submit" 
                    class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center"
                    {% if user.is_admin and user.id != current_user.id %}disabled{% endif %}>
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              L∆∞u thay ƒë·ªïi
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Ban Modal -->
<div id="banModal" class="fixed inset-0 z-[60] hidden">
  <div class="fixed inset-0 bg-black/50" onclick="closeBanModal()"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-xl max-w-md w-full p-6 relative">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
        üö´ Ban User: {{ user.username }}
      </h3>
      <form action="{{ url_for('admin.ban_user', user_id=user.id) }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            L√Ω do ban
          </label>
          <textarea name="reason" rows="3" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-red-500 focus:border-transparent"
                    placeholder="Nh·∫≠p l√Ω do..."></textarea>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closeBanModal()" 
                  class="px-4 py-2 bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600 transition-colors">
            H·ªßy
          </button>
          <button type="submit" 
                  class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
            Ban User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="fixed inset-0 z-[60] hidden">
  <div class="fixed inset-0 bg-black/50" onclick="closeDeleteModal()"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-xl max-w-md w-full p-6 relative">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
        ‚ö†Ô∏è X√°c nh·∫≠n x√≥a user
      </h3>
      <p class="text-gray-600 dark:text-gray-400 mb-6">
        B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a user <strong>{{ user.username }}</strong>? 
        H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c v√† s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu c·ªßa user.
      </p>
      <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closeDeleteModal()" 
                  class="px-4 py-2 bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600 transition-colors">
            H·ªßy
          </button>
          <button type="submit" 
                  class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
            X√≥a User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Quick Action Forms -->
<form id="quickActionForm" method="POST" class="hidden">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
function toggleProFields() {
  const planType = document.getElementById('plan_type').value;
  const proFields = document.getElementById('proFields');
  if (planType === 'pro') {
    proFields.classList.remove('hidden');
  } else {
    proFields.classList.add('hidden');
  }
}

function openBanModal() {
  document.getElementById('banModal').classList.remove('hidden');
}

function closeBanModal() {
  document.getElementById('banModal').classList.add('hidden');
}

function openDeleteModal() {
  document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.add('hidden');
}

function submitQuickAction(action) {
  const form = document.getElementById('quickActionForm');
  const userId = {{ user.id }};
  
  const actions = {
    'unban': `/admin/unban/${userId}`,
    'reset_trial': `/admin/reset-trial/${userId}`,
    'upgrade': `/admin/upgrade/${userId}`,
    'downgrade': `/admin/downgrade/${userId}`
  };
  
  if (actions[action]) {
    form.action = actions[action];
    form.submit();
  }
}
</script>
{% endblock %}
