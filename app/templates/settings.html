{% extends "base_dashboard.html" %}
{% block title %}{{ t.settings_title }} - Crawl Comments{% endblock %}

{% block content %}
<div class="p-8">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ t.settings_title }}</h1>
    <p class="text-gray-600 dark:text-gray-400 mt-1">{{ t.settings_subtitle }}</p>
  </div>

  <!-- Grid 2 c·ªôt cho TikTok v√† Facebook -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- TikTok Cookie Card -->
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
      <div class="p-6 border-b border-gray-100 dark:border-slate-700 bg-gradient-to-r from-pink-500 to-rose-500 rounded-t-xl">
        <div class="flex items-center">
          <img src="{{ url_for('static', filename='icon/icon-tiktok.png') }}" alt="TikTok" class="h-10 w-10 mr-3" />
          <div>
            <h2 class="text-xl font-semibold text-white">{{ t.tiktok_cookie }}</h2>
            <p class="text-sm text-pink-100">{{ t.tiktok_cookie_desc }}</p>
          </div>
        </div>
      </div>

      <div class="p-6">
        <!-- N√∫t l·∫•y Cookie t·ª´ Extension -->
        <div class="mb-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/30 dark:to-pink-900/30 border border-purple-200 dark:border-purple-800 rounded-lg">
          <div class="flex items-start">
            <svg class="h-6 w-6 text-purple-600 dark:text-purple-400 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            <div class="flex-1">
              <h4 class="text-sm font-semibold text-purple-800 dark:text-purple-300 mb-1">üöÄ L·∫•y Cookie T·ª± ƒê·ªông t·ª´ Extension</h4>
              <p class="text-xs text-purple-600 dark:text-purple-400 mb-3">Extension s·∫Ω t·ª± ƒë·ªông l·∫•y cookie t·ª´ TikTok n·∫øu b·∫°n ƒë√£ ƒëƒÉng nh·∫≠p.</p>
              
              <button type="button" id="btn-grab-tiktok-ext" onclick="grabFromExtension('tiktok')" 
                class="w-full px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all font-medium text-sm">
                <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                L·∫•y t·ª´ Extension
              </button>
              
              <!-- Status message -->
              <div id="tiktok-ext-status" class="hidden mt-3 p-2 rounded-lg text-sm"></div>
            </div>
          </div>
        </div>

        <!-- Cookie t·ª´ Extension (hi·ªán ·ªü tr√™n) -->
        {% if tiktok_cookie_info and tiktok_cookie_info.filename == 'extension' %}
        <div class="mb-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 border border-green-200 dark:border-green-800 rounded-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <span class="text-green-600 text-xl mr-2">‚úÖ</span>
              <div>
                <p class="text-sm font-medium text-green-800 dark:text-green-300">Cookie TikTok ƒë√£ s·∫µn s√†ng!</p>
                <p class="text-xs text-green-600 dark:text-green-400">{{ tiktok_cookie_info.count }} cookies t·ª´ Extension</p>
              </div>
            </div>
            <div class="flex space-x-2">
              <form method="POST" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="action" value="toggle_cookie" />
                <input type="hidden" name="platform" value="tiktok" />
                <button type="submit" class="px-3 py-1.5 text-xs border border-gray-300 dark:border-slate-600 rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600">
                  {% if tiktok_cookie_info.active %}{{ t.disable }}{% else %}{{ t.enable }}{% endif %}
                </button>
              </form>
              <button type="button" onclick="grabFromExtension('tiktok')" class="px-3 py-1.5 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                üîÑ L√†m m·ªõi
              </button>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- JS status message placeholder (hidden, only for temporary feedback) -->
        <div id="tiktok-cookie-status" class="hidden"></div>
        
        <div class="relative my-4">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-200 dark:border-slate-600"></div>
          </div>
          <div class="relative flex justify-center">
            <span class="px-3 bg-white dark:bg-slate-800 text-sm text-gray-500 dark:text-gray-400">Ho·∫∑c upload file</span>
          </div>
        </div>

        <!-- Cookie t·ª´ Upload (hi·ªán ·ªü d∆∞·ªõi) -->
        {% if tiktok_cookie_info and tiktok_cookie_info.filename != 'extension' %}
        <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-4">
          <div class="flex items-start">
            <svg class="h-5 w-5 text-green-600 dark:text-green-400 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="flex-1">
              <p class="text-sm text-green-800 dark:text-green-300"><strong>{{ t.file }}:</strong> {{ tiktok_cookie_info.filename }}</p>
              <p class="text-sm text-green-800 dark:text-green-300"><strong>{{ t.cookies }}:</strong> {{ tiktok_cookie_info.count }}</p>
              <p class="text-sm text-green-800 dark:text-green-300">
                <strong>{{ t.cookie_status }}:</strong>
                {% if tiktok_cookie_info.active %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200">{{ t.active }}</span>
                {% else %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-300">{{ t.inactive }}</span>
                {% endif %}
              </p>
            </div>
          </div>
          <div class="mt-3 flex space-x-2">
            <form method="POST" class="inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <input type="hidden" name="action" value="toggle_cookie" />
              <input type="hidden" name="platform" value="tiktok" />
              <button type="submit" class="text-xs px-3 py-1.5 border border-gray-300 dark:border-slate-600 rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600">
                {% if tiktok_cookie_info.active %}{{ t.disable }}{% else %}{{ t.enable }}{% endif %}
              </button>
            </form>
            <form method="POST" class="inline" onsubmit="return confirm('{{ t.confirm_delete_tiktok }}');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <input type="hidden" name="action" value="delete_cookie" />
              <input type="hidden" name="platform" value="tiktok" />
              <button type="submit" class="text-xs px-3 py-1.5 border border-red-300 dark:border-red-700 rounded-md text-red-700 dark:text-red-400 bg-white dark:bg-slate-700 hover:bg-red-50 dark:hover:bg-red-900/30">
                {{ t.delete }}
              </button>
            </form>
          </div>
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="action" value="upload_cookie" />
          <input type="hidden" name="platform" value="tiktok" />
          <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 dark:border-slate-600 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <svg class="w-8 h-8 mb-2 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              <p class="text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">{{ t.click_to_select }}</span></p>
              <p class="text-xs text-gray-500 dark:text-gray-400">{{ t.tiktok_cookie }} (.json)</p>
            </div>
            <input type="file" name="cookie_file" accept=".json" class="hidden" onchange="this.form.submit()" />
          </label>
        </form>
      </div>
    </div>

    <!-- Facebook Cookie Card -->
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
      <div class="p-6 border-b border-gray-100 dark:border-slate-700 bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-xl">
        <div class="flex items-center">
          <img src="{{ url_for('static', filename='icon/icon-facebook.png') }}" alt="Facebook" class="h-10 w-10 mr-3" />
          <div>
            <h2 class="text-xl font-semibold text-white">{{ t.facebook_cookie }}</h2>
            <p class="text-sm text-blue-100">{{ t.facebook_cookie_desc }}</p>
          </div>
        </div>
      </div>

      <div class="p-6">
        <!-- N√∫t l·∫•y Cookie t·ª´ Extension cho Facebook -->
        <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 border border-blue-200 dark:border-blue-800 rounded-lg">
          <div class="flex items-start">
            <svg class="h-6 w-6 text-blue-600 dark:text-blue-400 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            <div class="flex-1">
              <h4 class="text-sm font-semibold text-blue-800 dark:text-blue-300 mb-1">üöÄ L·∫•y Cookie T·ª± ƒê·ªông t·ª´ Extension</h4>
              <p class="text-xs text-blue-600 dark:text-blue-400 mb-3">Extension s·∫Ω t·ª± ƒë·ªông l·∫•y cookie t·ª´ Facebook n·∫øu b·∫°n ƒë√£ ƒëƒÉng nh·∫≠p.</p>
              
              <button type="button" id="btn-grab-facebook-ext" onclick="grabFromExtension('facebook')" 
                class="w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all font-medium text-sm">
                <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                L·∫•y t·ª´ Extension
              </button>
              
              <!-- Status message -->
              <div id="facebook-ext-status" class="hidden mt-3 p-2 rounded-lg text-sm"></div>
            </div>
          </div>
        </div>

        <!-- Cookie t·ª´ Extension (hi·ªán ·ªü tr√™n) -->
        {% if facebook_cookie_info and facebook_cookie_info.filename == 'extension' %}
        <div class="mb-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 border border-green-200 dark:border-green-800 rounded-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <span class="text-green-600 text-xl mr-2">‚úÖ</span>
              <div>
                <p class="text-sm font-medium text-green-800 dark:text-green-300">Cookie Facebook ƒë√£ s·∫µn s√†ng!</p>
                <p class="text-xs text-green-600 dark:text-green-400">{{ facebook_cookie_info.count }} cookies t·ª´ Extension</p>
              </div>
            </div>
            <div class="flex space-x-2">
              <form method="POST" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="action" value="toggle_cookie" />
                <input type="hidden" name="platform" value="facebook" />
                <button type="submit" class="px-3 py-1.5 text-xs border border-gray-300 dark:border-slate-600 rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600">
                  {% if facebook_cookie_info.active %}{{ t.disable }}{% else %}{{ t.enable }}{% endif %}
                </button>
              </form>
              <button type="button" onclick="grabFromExtension('facebook')" class="px-3 py-1.5 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                üîÑ L√†m m·ªõi
              </button>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- JS status message placeholder (hidden, only for temporary feedback) -->
        <div id="facebook-cookie-status" class="hidden"></div>
        
        <div class="relative my-4">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-200 dark:border-slate-600"></div>
          </div>
          <div class="relative flex justify-center">
            <span class="px-3 bg-white dark:bg-slate-800 text-sm text-gray-500 dark:text-gray-400">Ho·∫∑c upload file</span>
          </div>
        </div>

        <!-- Cookie t·ª´ Upload (hi·ªán ·ªü d∆∞·ªõi) -->
        {% if facebook_cookie_info and facebook_cookie_info.filename != 'extension' %}
        <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-4">
          <div class="flex items-start">
            <svg class="h-5 w-5 text-green-600 dark:text-green-400 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="flex-1">
              <p class="text-sm text-green-800 dark:text-green-300"><strong>{{ t.file }}:</strong> {{ facebook_cookie_info.filename }}</p>
              <p class="text-sm text-green-800 dark:text-green-300"><strong>{{ t.cookies }}:</strong> {{ facebook_cookie_info.count }}</p>
              <p class="text-sm text-green-800 dark:text-green-300">
                <strong>{{ t.cookie_status }}:</strong>
                {% if facebook_cookie_info.active %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200">{{ t.active }}</span>
                {% else %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-300">{{ t.inactive }}</span>
                {% endif %}
              </p>
            </div>
          </div>
          <div class="mt-3 flex space-x-2">
            <form method="POST" class="inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <input type="hidden" name="action" value="toggle_cookie" />
              <input type="hidden" name="platform" value="facebook" />
              <button type="submit" class="text-xs px-3 py-1.5 border border-gray-300 dark:border-slate-600 rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600">
                {% if facebook_cookie_info.active %}{{ t.disable }}{% else %}{{ t.enable }}{% endif %}
              </button>
            </form>
            <form method="POST" class="inline" onsubmit="return confirm('{{ t.confirm_delete_facebook }}');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <input type="hidden" name="action" value="delete_cookie" />
              <input type="hidden" name="platform" value="facebook" />
              <button type="submit" class="text-xs px-3 py-1.5 border border-red-300 dark:border-red-700 rounded-md text-red-700 dark:text-red-400 bg-white dark:bg-slate-700 hover:bg-red-50 dark:hover:bg-red-900/30">
                {{ t.delete }}
              </button>
            </form>
          </div>
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="action" value="upload_cookie" />
          <input type="hidden" name="platform" value="facebook" />
          <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 dark:border-slate-600 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <svg class="w-8 h-8 mb-2 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              <p class="text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">{{ t.click_to_select }}</span></p>
              <p class="text-xs text-gray-500 dark:text-gray-400">{{ t.facebook_cookie }} (.json)</p>
            </div>
            <input type="file" name="cookie_file" accept=".json" class="hidden" onchange="this.form.submit()" />
          </label>
        </form>
      </div>
    </div>
  </div>

  <!-- Proxy Settings Card - CH·ªà ADMIN M·ªöI TH·∫§Y -->
  {% if current_user.is_admin %}
  <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 mb-8">
    <div class="p-6 border-b border-gray-100 dark:border-slate-700 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-t-xl">
      <div class="flex items-center">
        <svg class="h-10 w-10 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
        </svg>
        <div>
          <h2 class="text-xl font-semibold text-white">{{ t.proxy_settings }}</h2>
          <p class="text-sm text-emerald-100">Qu·∫£n l√Ω Proxy trong Admin Panel</p>
        </div>
      </div>
    </div>

    <div class="p-6">
      <div class="p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg">
        <div class="flex items-center">
          <svg class="h-5 w-5 text-blue-600 dark:text-blue-400 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
          </svg>
          <div>
            <p class="text-sm text-blue-800 dark:text-blue-300">
              Proxy Settings ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang <strong>Admin Panel</strong>. 
              <a href="{{ url_for('admin.dashboard') }}" class="underline hover:text-blue-600">ƒêi ƒë·∫øn Admin Panel ‚Üí</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if current_user.is_admin %}
  <!-- Chrome Extension Card - Admin Only -->
  <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 mb-8">
    <div class="p-6 border-b border-gray-100 dark:border-slate-700 bg-gradient-to-r from-orange-500 to-red-500 rounded-t-xl">
      <div class="flex items-center">
        <svg class="h-10 w-10 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z"/>
        </svg>
        <div>
          <h2 class="text-xl font-semibold text-white">üß© Chrome Extension</h2>
          <p class="text-sm text-orange-100">L·∫•y cookie tr·ª±c ti·∫øp t·ª´ browser c·ªßa b·∫°n</p>
        </div>
      </div>
    </div>

    <div class="p-6">
      <!-- Extension Token -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          üîë API Token cho Extension
        </label>
        <div class="flex space-x-2">
          <input type="text" id="extension-token" readonly
            class="flex-1 px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700 text-gray-900 dark:text-gray-100 font-mono text-sm"
            placeholder="Click 'T·∫°o Token' ƒë·ªÉ l·∫•y token">
          <button type="button" id="btn-generate-token" onclick="generateExtensionToken()" 
            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm font-medium">
            T·∫°o Token
          </button>
          <button type="button" onclick="copyToken()" id="btn-copy-token"
            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm">
            üìã Copy
          </button>
        </div>
        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
          Copy token n√†y v√† d√°n v√†o Extension ƒë·ªÉ k·∫øt n·ªëi v·ªõi t√†i kho·∫£n c·ªßa b·∫°n.
        </p>
      </div>

      <!-- Download Extension -->
      <div class="p-4 bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/30 dark:to-red-900/30 border border-orange-200 dark:border-orange-800 rounded-lg">
        <h4 class="font-medium text-orange-800 dark:text-orange-300 mb-3">üì• C√†i ƒë·∫∑t Extension</h4>
        <ol class="text-sm text-orange-700 dark:text-orange-400 space-y-2 list-decimal list-inside">
          <li>T·∫£i Extension: <a href="/static/extension/cookie-grabber.zip" class="underline font-medium">Download ZIP</a> ho·∫∑c clone t·ª´ GitHub</li>
          <li>M·ªü Chrome ‚Üí <code class="bg-white dark:bg-slate-700 px-1 rounded">chrome://extensions</code></li>
          <li>B·∫≠t <strong>"Developer mode"</strong> (g√≥c ph·∫£i tr√™n)</li>
          <li>Click <strong>"Load unpacked"</strong> ‚Üí Ch·ªçn th∆∞ m·ª•c extension ƒë√£ gi·∫£i n√©n</li>
          <li>M·ªü Extension ‚Üí V√†o tab <strong>"C√†i ƒë·∫∑t"</strong> ‚Üí D√°n Token ·ªü tr√™n</li>
        </ol>
        
        <div class="mt-4 flex space-x-2">
          <a href="https://github.com/ntdung6868/Web-Social-Comment-Scraper/tree/main/extension" target="_blank"
            class="inline-flex items-center px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-colors text-sm">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            Xem tr√™n GitHub
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if current_user.is_admin %}
  <!-- Scraper Settings Card - Admin Only -->
  <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 mb-8">
    <div class="p-6 border-b border-gray-100 dark:border-slate-700 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-t-xl">
      <div class="flex items-center">
        <svg class="h-10 w-10 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <div>
          <h2 class="text-xl font-semibold text-white">{{ t.scraper_settings }}</h2>
          <p class="text-sm text-purple-100">{{ t.scraper_settings_desc }}</p>
        </div>
      </div>
    </div>

    <div class="p-6">
      <div class="mb-6">
        <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-slate-700 rounded-lg">
          <div class="flex-1">
            <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ t.headless_mode }}</h3>
          </div>
          <label class="relative inline-flex items-center cursor-pointer ml-4">
            <input type="checkbox" id="headless_toggle" class="sr-only peer" {% if scraper_settings is not defined or scraper_settings.headless_mode %}checked{% endif %} onchange="toggleHeadlessMode(this)" />
            <div class="w-11 h-6 bg-gray-200 dark:bg-slate-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
            <span id="headless_status" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">{% if scraper_settings is not defined or scraper_settings.headless_mode %}{{ t.on }}{% else %}{{ t.off }}{% endif %}</span>
          </label>
        </div>
      </div>

      <div class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded-lg">
        <div class="flex">
          <svg class="h-5 w-5 text-yellow-600 dark:text-yellow-400 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <div>
            <h4 class="text-sm font-medium text-yellow-800 dark:text-yellow-300">{{ t.headless_tip_title }}</h4>
            <ul class="text-sm text-yellow-700 dark:text-yellow-400 mt-1 list-disc list-inside space-y-1">
              <li><strong>{{ t.headless_tip_1 }}</strong></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- H∆∞·ªõng d·∫´n -->
  <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
    <div class="p-6 border-b border-gray-100 dark:border-slate-700">
      <h2 class="text-xl font-semibold text-gray-900 dark:text-white">{{ t.cookie_guide_title }}</h2>
    </div>
    <div class="p-6">
      <div class="prose prose-sm max-w-none text-gray-600 dark:text-gray-300">
        <ol class="list-decimal list-inside space-y-3">
          <li>
            <strong class="text-gray-800 dark:text-gray-200">{{ t.cookie_guide_step1 }}</strong> {{ t.cookie_guide_step1_desc }}
            <a href="https://chromewebstore.google.com/detail/j2team-cookies/okpidcojinmlaakglciglbpcpajaibco" target="_blank" class="text-primary-600 dark:text-primary-400 hover:underline">J2TEAM Cookies</a>
            {{ t.cookie_guide_or }}
            <a href="https://chrome.google.com/webstore/detail/cookie-editor/hlkenndednhfkekhgcdicdfddnkalmdm" target="_blank" class="text-primary-600 dark:text-primary-400 hover:underline">Cookie-Editor</a>
          </li>
          <li><strong class="text-gray-800 dark:text-gray-200">{{ t.cookie_guide_step2 }}</strong> {{ t.cookie_guide_step2_desc }}</li>
          <li><strong class="text-gray-800 dark:text-gray-200">{{ t.cookie_guide_step3 }}</strong> {{ t.cookie_guide_step3_desc }}</li>
          <li><strong class="text-gray-800 dark:text-gray-200">{{ t.cookie_guide_step4 }}</strong> {{ t.cookie_guide_step4_desc }}</li>
        </ol>

        <div class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded-lg">
          <div class="flex">
            <svg class="h-5 w-5 text-yellow-600 dark:text-yellow-400 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <div>
              <h4 class="text-sm font-medium text-yellow-800 dark:text-yellow-300">{{ t.security_note_title }}</h4>
              <p class="text-sm text-yellow-700 dark:text-yellow-400 mt-1">{{ t.security_note }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function toggleHeadlessMode(checkbox) {
    const isChecked = checkbox.checked;
    const statusEl = document.getElementById('headless_status');
    const onText = '{{ t.on }}';
    const offText = '{{ t.off }}';
    
    statusEl.textContent = isChecked ? onText : offText;
    
    fetch('/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'csrf_token': '{{ csrf_token() }}',
            'action': 'save_scraper_settings',
            'headless_mode': isChecked ? 'on' : ''
        })
    })
    .then(response => {
        if (response.ok) {
            statusEl.classList.add('text-green-600');
            setTimeout(() => {
                statusEl.classList.remove('text-green-600');
            }, 1000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        checkbox.checked = !isChecked;
        statusEl.textContent = !isChecked ? onText : offText;
    });
}

// ============================================
// Extension Cookie Grabber Functions
// ============================================
const EXTENSION_ID = 'your-extension-id'; // Will be detected automatically

// G·ª≠i message ƒë·∫øn extension
function sendMessageToExtension(action, data, callback) {
    // G·ª≠i message qua custom event
    window.postMessage({
        type: 'FROM_PAGE_TO_EXTENSION',
        action: action,
        data: data
    }, '*');
    
    // Listen for response
    const responseHandler = function(event) {
        if (event.data && event.data.type === 'FROM_EXTENSION_TO_PAGE' && event.data.action === action) {
            window.removeEventListener('message', responseHandler);
            callback(event.data.response);
        }
    };
    window.addEventListener('message', responseHandler);
    
    // Timeout after 3 seconds
    setTimeout(() => {
        window.removeEventListener('message', responseHandler);
    }, 3000);
}

// Check if extension is installed
function checkExtensionInstalled() {
    return new Promise((resolve) => {
        let responded = false;
        
        const handler = function(event) {
            if (event.data && event.data.type === 'FROM_EXTENSION_TO_PAGE' && event.data.action === 'ping') {
                responded = true;
                window.removeEventListener('message', handler);
                resolve(true);
            }
        };
        window.addEventListener('message', handler);
        
        window.postMessage({
            type: 'FROM_PAGE_TO_EXTENSION',
            action: 'ping'
        }, '*');
        
        // Wait 1.5 seconds for response
        setTimeout(() => {
            window.removeEventListener('message', handler);
            if (!responded) resolve(false);
        }, 1500);
    });
}

// Hi·ªÉn th·ªã modal h∆∞·ªõng d·∫´n c√†i extension
function showExtensionInstallModal() {
    // Remove existing modal if any
    const existingModal = document.getElementById('extension-install-modal');
    if (existingModal) existingModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'extension-install-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
            <div class="p-6 bg-gradient-to-r from-purple-600 to-pink-600">
                <h3 class="text-xl font-bold text-white">üß© C√†i ƒë·∫∑t Extension</h3>
                <p class="text-purple-100 text-sm mt-1">Extension gi√∫p t·ª± ƒë·ªông l·∫•y cookie m√† kh√¥ng c·∫ßn thao t√°c th·ªß c√¥ng</p>
            </div>
            <div class="p-6">
                <ol class="text-sm text-gray-700 dark:text-gray-300 space-y-3 list-decimal list-inside">
                    <li>
                        <strong>T·∫£i Extension:</strong>
                        <a href="{{ url_for('static', filename='extension/cookie-grabber.zip') }}" download
                           class="text-purple-600 hover:underline ml-1">Download ZIP</a>
                    </li>
                    <li><strong>Gi·∫£i n√©n</strong> file ZIP v·ª´a t·∫£i</li>
                    <li><strong>M·ªü Chrome</strong> ‚Üí V√†o <code class="bg-gray-100 dark:bg-slate-700 px-1 rounded">chrome://extensions</code></li>
                    <li>B·∫≠t <strong>"Developer mode"</strong> (g√≥c ph·∫£i tr√™n)</li>
                    <li>Click <strong>"Load unpacked"</strong> ‚Üí Ch·ªçn th∆∞ m·ª•c extension ƒë√£ gi·∫£i n√©n</li>
                </ol>
                
                <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                    <p class="text-xs text-yellow-700 dark:text-yellow-400">
                        <strong>üí° L∆∞u √Ω:</strong> Sau khi c√†i extension, h√£y <strong>refresh l·∫°i trang n√†y</strong> v√† b·∫•m "L·∫•y t·ª´ Extension" l·∫ßn n·ªØa.
                    </p>
                </div>
            </div>
            <div class="px-6 pb-6 flex justify-end space-x-3">
                <button onclick="document.getElementById('extension-install-modal').remove()" 
                    class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                    ƒê√≥ng
                </button>
                <a href="{{ url_for('static', filename='extension/cookie-grabber.zip') }}" download
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    T·∫£i Extension
                </a>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close on backdrop click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Grab from Extension
async function grabFromExtension(platform) {
    const btn = document.getElementById(`btn-grab-${platform}-ext`);
    const statusEl = document.getElementById(`${platform}-ext-status`);
    
    // Show loading
    btn.disabled = true;
    btn.innerHTML = `<svg class="animate-spin w-4 h-4 inline-block mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> ƒêang ki·ªÉm tra...`;
    statusEl.classList.add('hidden');
    
    // Step 1: Check if extension is installed
    const hasExtension = await checkExtensionInstalled();
    
    if (!hasExtension) {
        btn.disabled = false;
        btn.innerHTML = `<svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg> L·∫•y t·ª´ Extension`;
        showExtensionInstallModal();
        return;
    }
    
    // Step 2: Get token from server for this user
    btn.innerHTML = `<svg class="animate-spin w-4 h-4 inline-block mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> ƒêang l·∫•y cookie...`;
    
    let token = null;
    try {
        const tokenResponse = await fetch('/api/extension/get-token', {
            method: 'GET',
            headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
        });
        const tokenData = await tokenResponse.json();
        if (tokenData.success) {
            token = tokenData.token;
        }
    } catch (e) {
        console.error('Failed to get token:', e);
    }
    
    // Get current server URL
    const serverUrl = window.location.origin;
    
    // Send grab request to extension with token
    window.postMessage({
        type: 'FROM_PAGE_TO_EXTENSION',
        action: 'grabCookies',
        data: { 
            platform: platform,
            token: token,
            serverUrl: serverUrl
        }
    }, '*');
    
    // Wait for response or timeout
    const grabPromise = new Promise((resolve) => {
        const handler = function(event) {
            if (event.data && event.data.type === 'FROM_EXTENSION_TO_PAGE' && event.data.action === 'grabCookies') {
                window.removeEventListener('message', handler);
                resolve(event.data.response);
            }
        };
        window.addEventListener('message', handler);
        
        // Timeout after 10 seconds
        setTimeout(() => {
            window.removeEventListener('message', handler);
            resolve({ success: false, error: 'timeout' });
        }, 10000);
    });
    
    const result = await grabPromise;
    
    // Reset button
    btn.disabled = false;
    btn.innerHTML = `<svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg> L·∫•y t·ª´ Extension`;
    
    if (result.success) {
        statusEl.classList.remove('hidden', 'bg-red-100', 'text-red-700');
        statusEl.classList.add('bg-green-100', 'text-green-700');
        statusEl.innerHTML = `‚úÖ ƒê√£ l·∫•y ${result.count || 0} cookies th√†nh c√¥ng! ƒêang t·∫£i l·∫°i trang...`;
        
        showNotification(`üéâ ƒê√£ l·∫•y cookie ${platform.toUpperCase()} th√†nh c√¥ng!`, 'success');
        
        // Reload after 1.5 seconds to show updated status from server
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    } else if (result.error === 'not_logged_in') {
        statusEl.classList.remove('hidden', 'bg-green-100', 'text-green-700');
        statusEl.classList.add('bg-yellow-100', 'text-yellow-700');
        statusEl.innerHTML = `‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ${platform === 'tiktok' ? 'TikTok' : 'Facebook'} trong browser tr∆∞·ªõc, sau ƒë√≥ b·∫•m l·∫°i n√∫t n√†y.`;
        showNotification(`‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ${platform === 'tiktok' ? 'TikTok' : 'Facebook'}!`, 'warning');
    } else if (result.error === 'timeout') {
        statusEl.classList.remove('hidden', 'bg-green-100', 'text-green-700');
        statusEl.classList.add('bg-red-100', 'text-red-700');
        statusEl.innerHTML = `‚ùå Extension kh√¥ng ph·∫£n h·ªìi. Vui l√≤ng m·ªü extension v√† th·ª≠ l·∫°i.`;
        showNotification('‚ùå Extension kh√¥ng ph·∫£n h·ªìi', 'error');
    } else {
        statusEl.classList.remove('hidden', 'bg-green-100', 'text-green-700');
        statusEl.classList.add('bg-red-100', 'text-red-700');
        statusEl.innerHTML = `‚ùå L·ªói: ${result.error || 'Kh√¥ng x√°c ƒë·ªãnh'}`;
        showNotification(`‚ùå L·ªói: ${result.error || 'Kh√¥ng x√°c ƒë·ªãnh'}`, 'error');
    }
}

// Check cookie status on page load - disabled since Jinja already renders status
// This function is no longer needed as we removed JS-controlled status blocks
function checkCookieStatus() {
    // Do nothing - status is rendered by Jinja template
}

// ==================== OLD COOKIE GRABBER (for local use) ====================
let grabberCheckInterval = null;

function startCookieGrabber() {
    const btnStart = document.getElementById('btn-start-grabber');
    const statusDiv = document.getElementById('grabber-status');
    const messageEl = document.getElementById('grabber-message');
    
    if (!btnStart) return;
    
    btnStart.disabled = true;
    btnStart.innerHTML = '<svg class="animate-spin w-4 h-4 inline-block mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ƒêang m·ªü browser...';
    
    fetch('/api/cookie-grabber/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.classList.remove('hidden');
            btnStart.classList.add('hidden');
            messageEl.textContent = data.message;
            messageEl.classList.remove('text-red-600');
            messageEl.classList.add('text-gray-700', 'dark:text-gray-300');
            
            // B·∫Øt ƒë·∫ßu ki·ªÉm tra t·ª± ƒë·ªông m·ªói 3 gi√¢y
            startAutoCheck();
        } else {
            btnStart.disabled = false;
            btnStart.innerHTML = '<svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/></svg> M·ªü Browser & ƒêƒÉng Nh·∫≠p TikTok';
            alert('L·ªói: ' + data.message);
        }
    })
    .catch(error => {
        btnStart.disabled = false;
        btnStart.innerHTML = '<svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/></svg> M·ªü Browser & ƒêƒÉng Nh·∫≠p TikTok';
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
    });
}

function startAutoCheck() {
    if (grabberCheckInterval) {
        clearInterval(grabberCheckInterval);
    }
    grabberCheckInterval = setInterval(checkLoginStatus, 3000);
}

function stopAutoCheck() {
    if (grabberCheckInterval) {
        clearInterval(grabberCheckInterval);
        grabberCheckInterval = null;
    }
}

function checkLoginStatus() {
    const messageEl = document.getElementById('grabber-message');
    const btnGrab = document.getElementById('btn-grab-cookie');
    const spinner = document.getElementById('grabber-spinner');
    
    fetch('/api/cookie-grabber/status', {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.logged_in) {
            messageEl.textContent = '‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p! C√≥ ' + data.cookie_count + ' cookies.';
            messageEl.classList.remove('text-gray-700', 'dark:text-gray-300');
            messageEl.classList.add('text-green-600', 'dark:text-green-400');
            btnGrab.classList.remove('hidden');
            spinner.classList.add('hidden');
            stopAutoCheck();
        } else {
            messageEl.textContent = data.message || 'Ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p trong c·ª≠a s·ªï Chrome.';
            messageEl.classList.remove('text-green-600', 'dark:text-green-400');
            messageEl.classList.add('text-gray-700', 'dark:text-gray-300');
        }
    })
    .catch(error => {
        messageEl.textContent = 'L·ªói ki·ªÉm tra: ' + error.message;
        messageEl.classList.add('text-red-600');
    });
}

function grabCookies() {
    const messageEl = document.getElementById('grabber-message');
    const btnGrab = document.getElementById('btn-grab-cookie');
    const spinner = document.getElementById('grabber-spinner');
    
    btnGrab.disabled = true;
    btnGrab.textContent = 'ƒêang l·∫•y...';
    spinner.classList.remove('hidden');
    
    fetch('/api/cookie-grabber/grab', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageEl.textContent = 'üéâ ' + data.message;
            messageEl.classList.remove('text-gray-700', 'dark:text-gray-300');
            messageEl.classList.add('text-green-600', 'dark:text-green-400');
            
            // Hi·ªÉn th·ªã th√¥ng tin cookie
            if (data.important_found && data.important_found.length > 0) {
                messageEl.textContent += ' Cookie quan tr·ªçng: ' + data.important_found.join(', ');
            }
            
            // T·ª± ƒë·ªông reload trang sau 2 gi√¢y ƒë·ªÉ hi·ªÉn th·ªã cookie m·ªõi
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            messageEl.textContent = '‚ùå ' + data.message;
            messageEl.classList.add('text-red-600');
            btnGrab.disabled = false;
            btnGrab.textContent = 'L·∫•y Cookie';
        }
        spinner.classList.add('hidden');
    })
    .catch(error => {
        messageEl.textContent = 'L·ªói: ' + error.message;
        messageEl.classList.add('text-red-600');
        btnGrab.disabled = false;
        btnGrab.textContent = 'L·∫•y Cookie';
        spinner.classList.add('hidden');
    });
}

function closeCookieGrabber() {
    const btnStart = document.getElementById('btn-start-grabber');
    const statusDiv = document.getElementById('grabber-status');
    
    stopAutoCheck();
    
    fetch('/api/cookie-grabber/close', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        statusDiv.classList.add('hidden');
        btnStart.classList.remove('hidden');
        btnStart.disabled = false;
        btnStart.innerHTML = '<svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/></svg> M·ªü Browser & ƒêƒÉng Nh·∫≠p TikTok';
    });
}

// Cleanup khi r·ªùi trang
window.addEventListener('beforeunload', function() {
    stopAutoCheck();
});

// ==================== EXTENSION TOKEN FUNCTIONS ====================

function generateExtensionToken() {
    const tokenInput = document.getElementById('extension-token');
    const btnGenerate = document.getElementById('btn-generate-token');
    
    btnGenerate.disabled = true;
    btnGenerate.textContent = 'ƒêang t·∫°o...';
    
    fetch('/api/extension/get-token', {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            tokenInput.value = data.token;
            tokenInput.classList.remove('bg-gray-100', 'dark:bg-gray-700');
            tokenInput.classList.add('bg-green-50', 'dark:bg-green-900/20');
            
            // Show success message
            showNotification('‚úÖ Token ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!', 'success');
        } else {
            showNotification('‚ùå ' + data.message, 'error');
        }
        btnGenerate.disabled = false;
        btnGenerate.textContent = 'T·∫°o Token';
    })
    .catch(error => {
        showNotification('L·ªói: ' + error.message, 'error');
        btnGenerate.disabled = false;
        btnGenerate.textContent = 'T·∫°o Token';
    });
}

function copyToken() {
    const tokenInput = document.getElementById('extension-token');
    const token = tokenInput.value;
    
    if (!token) {
        showNotification('‚ö†Ô∏è Vui l√≤ng t·∫°o token tr∆∞·ªõc!', 'warning');
        return;
    }
    
    navigator.clipboard.writeText(token).then(() => {
        showNotification('üìã ƒê√£ copy token v√†o clipboard!', 'success');
    }).catch(err => {
        // Fallback for older browsers
        tokenInput.select();
        document.execCommand('copy');
        showNotification('üìã ƒê√£ copy token!', 'success');
    });
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-y-0';
    
    if (type === 'success') {
        notification.classList.add('bg-green-500', 'text-white');
    } else if (type === 'error') {
        notification.classList.add('bg-red-500', 'text-white');
    } else if (type === 'warning') {
        notification.classList.add('bg-yellow-500', 'text-white');
    } else {
        notification.classList.add('bg-blue-500', 'text-white');
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-y-full', 'opacity-0');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Check cookie status from extension on page load
function checkExtensionCookieStatus() {
    // This function is replaced by checkCookieStatus above
}

function refreshFromExtension() {
    showNotification('üí° M·ªü Extension v√† b·∫•m "L·∫•y Cookie TikTok" ƒë·ªÉ c·∫≠p nh·∫≠t cookie m·ªõi!', 'info');
}

// Load existing token on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if there's already a token (only for admin)
    const tokenInput = document.getElementById('extension-token');
    if (tokenInput) {
        fetch('/api/extension/get-token', {
            method: 'GET',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.token) {
                tokenInput.value = data.token;
            }
        })
        .catch(() => {});
    }
    
    // Check cookie status on page load
    checkCookieStatus();
});
</script>
{% endblock %}
